# 管理画面認証機能実装ガイド

**作成日**: 2025年7月22日  
**作成者**: Claude Code  
**ステータス**: 未実装  

---

## 📋 概要

本ドキュメントは、作業記録データベースの管理画面に認証機能を実装するためのガイドです。現在、API側には認証機能が実装されていますが、クライアント側に問題があるため、完全な認証システムとして機能していません。

---

## 🔍 現状分析

### 実装済みの部分

1. **APIレベルの認証機能** ✅
   - すべての管理画面APIエンドポイントで`checkAdminAuth`関数による認証チェック
   - Bearerトークン方式での認証
   - 環境変数による設定管理

2. **認証チェック関数** (`src/app/api/admin/drawings/route.ts`)
   ```typescript
   function checkAdminAuth(request: NextRequest): boolean {
     const adminPassword = process.env.ADMIN_PASSWORD
     const adminEnabled = process.env.ADMIN_ENABLED === 'true'
     
     if (!adminEnabled) {
       return false
     }
     
     const authHeader = request.headers.get('authorization')
     if (!authHeader || !adminPassword) {
       return false
     }
     
     const token = authHeader.replace('Bearer ', '')
     return token === adminPassword
   }
   ```

### 問題点

1. **クライアント側のハードコーディング**
   - 新規登録画面: `'admin123'`がハードコード
   - 環境変数の不一致: サーバー側`ADMIN_PASSWORD` vs クライアント側`NEXT_PUBLIC_ADMIN_PASSWORD`

2. **編集画面での認証ヘッダー欠如**
   - ファイルアップロード・削除時に認証ヘッダーが含まれていない

3. **ログイン画面の不在**
   - パスワード入力画面がない
   - セッション管理がない

---

## 🎯 実装方針

### シンプルな認証システムの構築

1. **パスワードベース認証**
   - 単一の管理者パスワードで認証
   - セッション管理はlocalStorageで簡易実装
   - JWT等の複雑な仕組みは使用しない

2. **パスワード保存の仕組み**
   - **初回アクセス時**: パスワード入力画面を表示
   - **入力後**: localStorageに保存（ブラウザに永続保存）
   - **2回目以降**: 自動的に認証（入力不要）
   - **ログアウト**: localStorageをクリアすることで実現

3. **実装の優先順位**
   - Phase 1: 既存の問題修正（30分）
   - Phase 2: ログイン画面追加（1時間）
   - Phase 3: セッション管理（30分）

---

## 🚀 実装手順

### Phase 1: 既存の問題修正（必須・最優先）

#### 1. 環境変数の統一
`.env.local`ファイルで以下を設定：
```env
ADMIN_ENABLED=true
ADMIN_PASSWORD=your-secure-password-here
```

#### 2. クライアント側の修正
各管理画面でのAPI呼び出し時に、localStorageからパスワードを取得：

```typescript
// 認証ヘッダーを生成する共通関数
function getAuthHeaders(): HeadersInit {
  const adminPassword = localStorage.getItem('adminPassword') || ''
  return {
    'Authorization': `Bearer ${adminPassword}`,
    'Content-Type': 'application/json'
  }
}

// 使用例
const response = await fetch('/api/admin/drawings', {
  method: 'POST',
  headers: getAuthHeaders(),
  body: formData
})
```

#### 3. 編集画面の修正箇所
- `src/app/admin/drawings/[id]/edit/page.tsx`
  - `handleSubmit`関数
  - `handleFileUpload`関数
  - `removePdfOrProgramFile`関数
  - その他のAPI呼び出し部分

### Phase 2: ログイン画面の追加（推奨）

#### 1. ログインページの作成
`src/app/admin/login/page.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function AdminLogin() {
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const router = useRouter()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // 認証確認
    const response = await fetch('/api/admin/auth/verify', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${password}`,
        'Content-Type': 'application/json'
      }
    })

    if (response.ok) {
      // パスワードをlocalStorageに保存
      localStorage.setItem('adminPassword', password)
      router.push('/admin')
    } else {
      setError('パスワードが正しくありません')
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
      <div className="max-w-md w-full bg-white rounded-lg shadow p-8">
        <h1 className="text-2xl font-bold text-gray-900 mb-6">管理画面ログイン</h1>
        <form onSubmit={handleLogin}>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              パスワード
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>
          {error && (
            <p className="text-red-600 text-sm mb-4">{error}</p>
          )}
          <button
            type="submit"
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
          >
            ログイン
          </button>
        </form>
      </div>
    </div>
  )
}
```

#### 2. 認証確認APIの追加
`src/app/api/admin/auth/verify/route.ts`:
```typescript
export async function POST(request: NextRequest) {
  if (checkAdminAuth(request)) {
    return NextResponse.json({ success: true })
  }
  return NextResponse.json({ error: '認証失敗' }, { status: 401 })
}
```

### Phase 3: セッション管理（オプション）

#### 1. 認証状態の確認フック
`src/hooks/useAdminAuth.ts`:
```typescript
import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

export function useAdminAuth() {
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [loading, setLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    const checkAuth = async () => {
      const password = localStorage.getItem('adminPassword')
      
      if (!password) {
        router.push('/admin/login')
        return
      }

      const response = await fetch('/api/admin/auth/verify', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${password}`
        }
      })

      if (response.ok) {
        setIsAuthenticated(true)
      } else {
        localStorage.removeItem('adminPassword')
        router.push('/admin/login')
      }
      
      setLoading(false)
    }

    checkAuth()
  }, [router])

  return { isAuthenticated, loading }
}
```

#### 2. 各管理画面での使用
```typescript
export default function AdminPage() {
  const { isAuthenticated, loading } = useAdminAuth()

  if (loading) {
    return <div>認証確認中...</div>
  }

  if (!isAuthenticated) {
    return null
  }

  // 通常のコンテンツ
  return <div>...</div>
}
```

---

## 🔒 セキュリティ考慮事項

1. **本番環境での注意**
   - 強力なパスワードを使用
   - HTTPSでの運用必須
   - 環境変数は絶対に公開しない

2. **将来的な改善案**
   - JWT トークンの導入
   - セッションの有効期限設定
   - ログイン履歴の記録
   - 多要素認証

---

## 📊 実装工数見積もり

| フェーズ | 内容 | 見積時間 | 優先度 |
|---------|------|----------|--------|
| Phase 1 | 既存問題の修正 | 30分 | 必須 |
| Phase 2 | ログイン画面 | 1時間 | 推奨 |
| Phase 3 | セッション管理 | 30分 | オプション |

**合計**: 約2時間

---

## 🎯 最小実装

急ぎの場合は、Phase 1のみ実装すれば最低限の認証は機能します：

1. 環境変数設定
2. ハードコードされた`'admin123'`を`prompt('管理者パスワードを入力してください')`に変更
3. 入力されたパスワードをlocalStorageに保存

これだけでも、基本的な認証機能として動作します。

### 認証フローの詳細

```
初回アクセス:
1. 管理画面URL（/admin/*）にアクセス
2. localStorageに'adminPassword'が存在しない
3. prompt()でパスワード入力を要求
4. 入力されたパスワードをlocalStorageに保存
5. 以降のAPIリクエストで自動的に使用

2回目以降:
1. 管理画面URL（/admin/*）にアクセス
2. localStorageから'adminPassword'を自動取得
3. パスワード入力なしで画面表示
4. APIリクエスト時も自動的に認証ヘッダーを付与

ログアウト時:
1. localStorage.removeItem('adminPassword')を実行
2. 次回アクセス時は再度パスワード入力が必要
```

### 保存期間とセキュリティ

- **保存期間**: ブラウザのlocalStorageに永続保存（手動削除まで）
- **ブラウザ間共有**: なし（ブラウザごとに入力が必要）
- **シークレットモード**: セッション終了時に自動削除
- **セキュリティ注意**: 共有PCでは使用後にログアウト推奨

---

**最終更新**: 2025年7月22日  
**作成者**: Claude Code  
**承認者**: 未定