# ç®¡ç†ç”»é¢èªè¨¼æ©Ÿèƒ½å®Ÿè£…ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025å¹´7æœˆ22æ—¥  
**ä½œæˆè€…**: Claude Code  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœªå®Ÿè£…  

---

## ğŸ“‹ æ¦‚è¦

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ä½œæ¥­è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç®¡ç†ç”»é¢ã«èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ç¾åœ¨ã€APIå´ã«ã¯èªè¨¼æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«å•é¡ŒãŒã‚ã‚‹ãŸã‚ã€å®Œå…¨ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦æ©Ÿèƒ½ã—ã¦ã„ã¾ã›ã‚“ã€‚

---

## ğŸ” ç¾çŠ¶åˆ†æ

### å®Ÿè£…æ¸ˆã¿ã®éƒ¨åˆ†

1. **APIãƒ¬ãƒ™ãƒ«ã®èªè¨¼æ©Ÿèƒ½** âœ…
   - ã™ã¹ã¦ã®ç®¡ç†ç”»é¢APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§`checkAdminAuth`é–¢æ•°ã«ã‚ˆã‚‹èªè¨¼ãƒã‚§ãƒƒã‚¯
   - Bearerãƒˆãƒ¼ã‚¯ãƒ³æ–¹å¼ã§ã®èªè¨¼
   - ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹è¨­å®šç®¡ç†

2. **èªè¨¼ãƒã‚§ãƒƒã‚¯é–¢æ•°** (`src/app/api/admin/drawings/route.ts`)
   ```typescript
   function checkAdminAuth(request: NextRequest): boolean {
     const adminPassword = process.env.ADMIN_PASSWORD
     const adminEnabled = process.env.ADMIN_ENABLED === 'true'
     
     if (!adminEnabled) {
       return false
     }
     
     const authHeader = request.headers.get('authorization')
     if (!authHeader || !adminPassword) {
       return false
     }
     
     const token = authHeader.replace('Bearer ', '')
     return token === adminPassword
   }
   ```

### å•é¡Œç‚¹

1. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°**
   - æ–°è¦ç™»éŒ²ç”»é¢: `'admin123'`ãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
   - ç’°å¢ƒå¤‰æ•°ã®ä¸ä¸€è‡´: ã‚µãƒ¼ãƒãƒ¼å´`ADMIN_PASSWORD` vs ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´`NEXT_PUBLIC_ADMIN_PASSWORD`

2. **ç·¨é›†ç”»é¢ã§ã®èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼æ¬ å¦‚**
   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤æ™‚ã«èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãªã„

3. **ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®ä¸åœ¨**
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ãŒãªã„
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãŒãªã„

---

## ğŸ¯ å®Ÿè£…æ–¹é‡

### ã‚·ãƒ³ãƒ—ãƒ«ãªèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰

1. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹èªè¨¼**
   - å˜ä¸€ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§èªè¨¼
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¯localStorageã§ç°¡æ˜“å®Ÿè£…
   - JWTç­‰ã®è¤‡é›‘ãªä»•çµ„ã¿ã¯ä½¿ç”¨ã—ãªã„

2. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿å­˜ã®ä»•çµ„ã¿**
   - **åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã‚’è¡¨ç¤º
   - **å…¥åŠ›å¾Œ**: localStorageã«ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã«æ°¸ç¶šä¿å­˜ï¼‰
   - **2å›ç›®ä»¥é™**: è‡ªå‹•çš„ã«èªè¨¼ï¼ˆå…¥åŠ›ä¸è¦ï¼‰
   - **ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ**: localStorageã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã“ã¨ã§å®Ÿç¾

3. **å®Ÿè£…ã®å„ªå…ˆé †ä½**
   - Phase 1: æ—¢å­˜ã®å•é¡Œä¿®æ­£ï¼ˆ30åˆ†ï¼‰
   - Phase 2: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¿½åŠ ï¼ˆ1æ™‚é–“ï¼‰
   - Phase 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆ30åˆ†ï¼‰

---

## ğŸš€ å®Ÿè£…æ‰‹é †

### Phase 1: æ—¢å­˜ã®å•é¡Œä¿®æ­£ï¼ˆå¿…é ˆãƒ»æœ€å„ªå…ˆï¼‰

#### 1. ç’°å¢ƒå¤‰æ•°ã®çµ±ä¸€
`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š
```env
ADMIN_ENABLED=true
ADMIN_PASSWORD=your-secure-password-here
```

#### 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¿®æ­£
å„ç®¡ç†ç”»é¢ã§ã®APIå‘¼ã³å‡ºã—æ™‚ã«ã€localStorageã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—ï¼š

```typescript
// èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹å…±é€šé–¢æ•°
function getAuthHeaders(): HeadersInit {
  const adminPassword = localStorage.getItem('adminPassword') || ''
  return {
    'Authorization': `Bearer ${adminPassword}`,
    'Content-Type': 'application/json'
  }
}

// ä½¿ç”¨ä¾‹
const response = await fetch('/api/admin/drawings', {
  method: 'POST',
  headers: getAuthHeaders(),
  body: formData
})
```

#### 3. ç·¨é›†ç”»é¢ã®ä¿®æ­£ç®‡æ‰€
- `src/app/admin/drawings/[id]/edit/page.tsx`
  - `handleSubmit`é–¢æ•°
  - `handleFileUpload`é–¢æ•°
  - `removePdfOrProgramFile`é–¢æ•°
  - ãã®ä»–ã®APIå‘¼ã³å‡ºã—éƒ¨åˆ†

### Phase 2: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®è¿½åŠ ï¼ˆæ¨å¥¨ï¼‰

#### 1. ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ä½œæˆ
`src/app/admin/login/page.tsx`:
```typescript
'use client'

import { useState } from 'react'
import { useRouter } from 'next/navigation'

export default function AdminLogin() {
  const [password, setPassword] = useState('')
  const [error, setError] = useState('')
  const router = useRouter()

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // èªè¨¼ç¢ºèª
    const response = await fetch('/api/admin/auth/verify', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${password}`,
        'Content-Type': 'application/json'
      }
    })

    if (response.ok) {
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’localStorageã«ä¿å­˜
      localStorage.setItem('adminPassword', password)
      router.push('/admin')
    } else {
      setError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“')
    }
  }

  return (
    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
      <div className="max-w-md w-full bg-white rounded-lg shadow p-8">
        <h1 className="text-2xl font-bold text-gray-900 mb-6">ç®¡ç†ç”»é¢ãƒ­ã‚°ã‚¤ãƒ³</h1>
        <form onSubmit={handleLogin}>
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-md"
              required
            />
          </div>
          {error && (
            <p className="text-red-600 text-sm mb-4">{error}</p>
          )}
          <button
            type="submit"
            className="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700"
          >
            ãƒ­ã‚°ã‚¤ãƒ³
          </button>
        </form>
      </div>
    </div>
  )
}
```

#### 2. èªè¨¼ç¢ºèªAPIã®è¿½åŠ 
`src/app/api/admin/auth/verify/route.ts`:
```typescript
export async function POST(request: NextRequest) {
  if (checkAdminAuth(request)) {
    return NextResponse.json({ success: true })
  }
  return NextResponse.json({ error: 'èªè¨¼å¤±æ•—' }, { status: 401 })
}
```

### Phase 3: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### 1. èªè¨¼çŠ¶æ…‹ã®ç¢ºèªãƒ•ãƒƒã‚¯
`src/hooks/useAdminAuth.ts`:
```typescript
import { useEffect, useState } from 'react'
import { useRouter } from 'next/navigation'

export function useAdminAuth() {
  const [isAuthenticated, setIsAuthenticated] = useState(false)
  const [loading, setLoading] = useState(true)
  const router = useRouter()

  useEffect(() => {
    const checkAuth = async () => {
      const password = localStorage.getItem('adminPassword')
      
      if (!password) {
        router.push('/admin/login')
        return
      }

      const response = await fetch('/api/admin/auth/verify', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${password}`
        }
      })

      if (response.ok) {
        setIsAuthenticated(true)
      } else {
        localStorage.removeItem('adminPassword')
        router.push('/admin/login')
      }
      
      setLoading(false)
    }

    checkAuth()
  }, [router])

  return { isAuthenticated, loading }
}
```

#### 2. å„ç®¡ç†ç”»é¢ã§ã®ä½¿ç”¨
```typescript
export default function AdminPage() {
  const { isAuthenticated, loading } = useAdminAuth()

  if (loading) {
    return <div>èªè¨¼ç¢ºèªä¸­...</div>
  }

  if (!isAuthenticated) {
    return null
  }

  // é€šå¸¸ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  return <div>...</div>
}
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **æœ¬ç•ªç’°å¢ƒã§ã®æ³¨æ„**
   - å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
   - HTTPSã§ã®é‹ç”¨å¿…é ˆ
   - ç’°å¢ƒå¤‰æ•°ã¯çµ¶å¯¾ã«å…¬é–‹ã—ãªã„

2. **å°†æ¥çš„ãªæ”¹å–„æ¡ˆ**
   - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®å°å…¥
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™è¨­å®š
   - ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã®è¨˜éŒ²
   - å¤šè¦ç´ èªè¨¼

---

## ğŸ“Š å®Ÿè£…å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| ãƒ•ã‚§ãƒ¼ã‚º | å†…å®¹ | è¦‹ç©æ™‚é–“ | å„ªå…ˆåº¦ |
|---------|------|----------|--------|
| Phase 1 | æ—¢å­˜å•é¡Œã®ä¿®æ­£ | 30åˆ† | å¿…é ˆ |
| Phase 2 | ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ | 1æ™‚é–“ | æ¨å¥¨ |
| Phase 3 | ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | 30åˆ† | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ |

**åˆè¨ˆ**: ç´„2æ™‚é–“

---

## ğŸ¯ æœ€å°å®Ÿè£…

æ€¥ãã®å ´åˆã¯ã€Phase 1ã®ã¿å®Ÿè£…ã™ã‚Œã°æœ€ä½é™ã®èªè¨¼ã¯æ©Ÿèƒ½ã—ã¾ã™ï¼š

1. ç’°å¢ƒå¤‰æ•°è¨­å®š
2. ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸ`'admin123'`ã‚’`prompt('ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')`ã«å¤‰æ›´
3. å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’localStorageã«ä¿å­˜

ã“ã‚Œã ã‘ã§ã‚‚ã€åŸºæœ¬çš„ãªèªè¨¼æ©Ÿèƒ½ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚

### èªè¨¼ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```
åˆå›ã‚¢ã‚¯ã‚»ã‚¹:
1. ç®¡ç†ç”»é¢URLï¼ˆ/admin/*ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹
2. localStorageã«'adminPassword'ãŒå­˜åœ¨ã—ãªã„
3. prompt()ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã‚’è¦æ±‚
4. å…¥åŠ›ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’localStorageã«ä¿å­˜
5. ä»¥é™ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§è‡ªå‹•çš„ã«ä½¿ç”¨

2å›ç›®ä»¥é™:
1. ç®¡ç†ç”»é¢URLï¼ˆ/admin/*ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹
2. localStorageã‹ã‚‰'adminPassword'ã‚’è‡ªå‹•å–å¾—
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãªã—ã§ç”»é¢è¡¨ç¤º
4. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã‚‚è‡ªå‹•çš„ã«èªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚:
1. localStorage.removeItem('adminPassword')ã‚’å®Ÿè¡Œ
2. æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã¯å†åº¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãŒå¿…è¦
```

### ä¿å­˜æœŸé–“ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **ä¿å­˜æœŸé–“**: ãƒ–ãƒ©ã‚¦ã‚¶ã®localStorageã«æ°¸ç¶šä¿å­˜ï¼ˆæ‰‹å‹•å‰Šé™¤ã¾ã§ï¼‰
- **ãƒ–ãƒ©ã‚¦ã‚¶é–“å…±æœ‰**: ãªã—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã”ã¨ã«å…¥åŠ›ãŒå¿…è¦ï¼‰
- **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰**: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«è‡ªå‹•å‰Šé™¤
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„**: å…±æœ‰PCã§ã¯ä½¿ç”¨å¾Œã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ¨å¥¨

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ22æ—¥  
**ä½œæˆè€…**: Claude Code  
**æ‰¿èªè€…**: æœªå®š