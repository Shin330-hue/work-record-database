# 管理画面仕様書

**作成日**: 2025年7月16日  
**バージョン**: 1.1.0  
**作成者**: Claude Code Analysis  
**ステータス**: 運用中（Phase 2まで実装完了）  

---

## 📋 プロジェクト概要

### システム名
**作業記録データベース管理画面** (Work Record Database Admin Panel)

### 目的
現在の手動データ更新プロセスをWeb UI化し、安全で効率的な管理システムを構築する

### 開発背景
- Excel → JSON 手動変換の負担
- 複数ファイルの個別更新による整合性リスク
- PowerShell コマンドでの手動作業
- データ整合性チェックの手動実施
- バックアップ仕組みの不備

---

## 🔄 現状の課題と解決策

### 現在の更新プロセス
```
Excelファイル → 手動変換 → JSON更新 → フォルダ作成 → 整合性チェック
```

### 新しい管理画面プロセス
```
Webフォーム → 自動変換 → 一括更新 → 自動作成 → 自動チェック
```

### 解決される課題
| 課題 | 解決策 |
|------|---------|
| 手動変換の負担 | Webフォームによる直接入力 |
| 複数ファイル更新 | 一括トランザクション処理 |
| 手動フォルダ作成 | 自動ディレクトリ生成 |
| 整合性チェック | リアルタイム検証 |
| バックアップ不備 | 自動バックアップ機能 |

---

## 🏗️ システム構成

### アーキテクチャ
- **フロントエンド**: Next.js 15 + React 19 + TypeScript
- **認証**: シンプルパスワード認証
- **データ**: 既存JSONファイル活用
- **ファイル管理**: 既存ファイル構造維持

### URL構成
```
/                    # メインサイト（閲覧＋追記）
/admin/              # 管理画面（認証必須）
  ├── login/         # ログイン画面
  ├── dashboard/     # ダッシュボード
  ├── drawings/      # 図番管理
  │   ├── list/      # 図番一覧
  │   ├── new/       # 新規登録
  │   └── [id]/edit/ # 編集
  ├── companies/     # 会社・製品管理
  ├── files/         # ファイル管理
  ├── contributions/ # 追記管理
  ├── tools/         # データツール
  └── audit-log/     # 監査ログ一覧
  └── tools/         # データツール
```

---

## 🚀 段階的実装プラン

### Phase 1: 基本管理機能（2-3日）
**目標**: 現在のデータを安全に閲覧・統計表示

**実装機能**:
- ✅ 認証画面（環境変数による有効/無効切り替え）
- ✅ ダッシュボード（統計情報表示）
- ✅ 図番一覧（検索・フィルタ機能）
- ✅ 追記データ管理画面
- ✅ データ整合性チェック機能

**技術要件**:
- 環境変数 `ADMIN_ENABLED` による機能制御
- 既存 `dataLoader.ts` の活用
- 読み取り専用機能
- レスポンシブデザイン

### Phase 2: 編集機能（1-2週間）
**目標**: Webフォームによるデータ編集

**実装機能**:
- ✅ 図番新規登録フォーム
- ✅ 図番編集フォーム
- ✅ ファイルアップロード機能
- ✅ 会社・製品管理
- ✅ プレビュー機能

**技術要件**:
- フォームバリデーション（Zod）
- ファイル処理API拡張
- トランザクション処理
- リアルタイムプレビュー

### Phase 3: 高度機能（2-3週間）
**目標**: 本格的なCMS機能

**実装機能**:
- ✅ Excel インポート/エクスポート
- ✅ 一括処理機能
- ✅ バックアップ・復元
- ✅ 監査ログ
- ✅ 権限管理強化

**技術要件**:
- Excel処理ライブラリ（xlsx）
- バックアップシステム
- ログ記録機能

### 監査ログ設計 (2025-10-11)
- **目的**
  - 複数社員での編集履歴を確認できるようにする
  - ファイルアップロードの記録を残し、不正ファイル対応に備える
  - 社内システム活用状況を可視化し評価指標に活用する
- **対象操作（優先順位順）**
  1. 図番・製品データの登録/編集/削除（管理APIおよび画面）
  2. 作業手順に紐づくファイルのアップロード/削除
  3. 認証イベント（ログイン/ログアウト/失敗）は余力があるタイミングで段階的に追加
- **記録項目**
  - timestamp（ISO8601）、actor（社員ID+氏名）、action（操作種別）、target（図番IDやファイルパス）
  - metadataとして差分概要、ファイル種別、クライアントIPなどを追加で保持
- **保存方式（案）**
  - public/data/audit/ 以下に月次ファイル（例: udit-2025-10.jsonl）として追記保存
  - JSON Lines形式で1行1イベントを記録し、バックアップ対象に含める
  - 読み取り専用API経由で参照し、直接編集は不可とする
- **運用・ガバナンス**
  - 保持期間や閲覧権限を運用チームと合意（評価制度で参照する場合は年度単位で保管）
  - 社員マスタ（public/data/auth/passwords.json）と連携し、操作ユーザーを一意に特定
  - 監査ログ自体の改ざん検知（ハッシュ/二重保存など）はPhase3以降の検討事項
- **実装メモ**
  - 管理API層（例: /api/admin/drawings, /api/admin/contributions）に共通ユーティリティ logAuditEvent() を挿入
  - フロントエンドからは既存APIを通じて操作ログが自動生成されるようにし、追加の手入力は不要
  - 低優先の認証イベントはユーティリティ準備後に段階的に拡張する
- **閲覧UI方針**
  - 管理ダッシュボードに『監査ログ』ボタンを追加し、閲覧専用の一覧画面へ遷移させる
  - ログは全社員が閲覧可能とし、編集・削除手段は提供しない（APIもGET専用）
  - まずは最新100件程度のテーブル表示を実装し、期間・操作種別・社員IDでのフィルタやエクスポートは後追い検討

- 権限管理システム

---

## 🔒 セキュリティ仕様
  - **記録対象**: drawing.create / drawing.update / drawing.files.upload / drawing.files.delete / contribution.updateStatus / contribution.delete
### 認証・認可
```typescript
// 環境変数による制御
ADMIN_ENABLED=true/false         # 管理画面の有効/無効
ADMIN_PASSWORD=secure_password   # 管理画面パスワード（初回アクセス時のみ）
ADMIN_IP_WHITELIST=192.168.1.0/24 # IP制限（オプション）
```

**認証方針**：
- 管理画面へのアクセス時に一度だけパスワード認証
- 登録・編集の都度の認証は不要
- 目的：編集フォーマット統一と同時編集防止

### アクセス制御
- **Phase 1**: 環境変数による表示制御
- **Phase 2**: パスワード認証（初回アクセス時のみ）
- **Phase 3**: セッション管理・IP制限

### ファイルアクセス方針
- **画像・動画表示**: 閲覧ページと同じ直接パス参照
- **理由**: 社内ネットワーク限定でセキュリティリスクなし
- **メリット**: パフォーマンス向上とコード統一

### データ保護
- ファイルパスサニタイゼーション
- 入力値検証
- CSRFプロテクション
- ファイルアップロード制限

---

## 🎨 UI/UX設計

### デザイン原則
- **一貫性**: 既存サイトとの統一感
- **安全性**: 危険な操作の明確な警告
- **効率性**: 最小クリック数での操作
- **レスポンシブ**: PC・タブレット対応

### カラーパレット
```css
--admin-primary: #1e40af;    /* 管理画面のメイン色 */
--admin-danger: #dc2626;     /* 削除・危険操作 */
--admin-success: #16a34a;    /* 成功・保存 */
--admin-warning: #d97706;    /* 警告・注意 */
```

### コンポーネント設計
- 再利用可能な管理用コンポーネント
- 既存UIコンポーネントの活用
- 管理画面専用レイアウト

---

## 🔧 API設計

### 新規API
```typescript
// 図番管理API
POST   /api/admin/drawings           # 図番新規作成
PUT    /api/admin/drawings/[id]      # 図番更新
DELETE /api/admin/drawings/[id]      # 図番削除
GET    /api/admin/drawings/validate  # 整合性チェック

// 会社・製品管理API
POST   /api/admin/companies          # 会社新規作成
PUT    /api/admin/companies/[id]     # 会社更新

// データ管理API
POST   /api/admin/data/import        # データインポート
GET    /api/admin/data/export        # データエクスポート
POST   /api/admin/data/backup        # バックアップ作成
```

### 既存API活用
- `/api/contribution` - 追記機能
- `/api/files` - ファイル配信
- `dataLoader.ts` - データ読み込み

---

## 📊 データ管理\n\n> **メモ (2025-10-10)**: 管理ダッシュボード上のデータ管理導線は混乱防止のため一旦非表示としています。機能を再設計する際に再度有効化予定です。

### データ構造維持
既存のJSON構造を完全に維持：
- `companies.json`
- `search-index.json`
- `work-instructions/drawing-*/instruction.json`

### 新規データ
```typescript
// 管理画面用メタデータ
interface AdminMetadata {
  lastUpdated: string;
  updatedBy: string;
  changeLog: ChangeLogEntry[];
}

// 変更ログ
interface ChangeLogEntry {
  timestamp: string;
  user: string;
  action: 'CREATE' | 'UPDATE' | 'DELETE';
  target: string;
  details: string;
}
```

---

## 🔍 テスト戦略

### テスト範囲
- **Unit Tests**: 個別コンポーネント・関数
- **Integration Tests**: API連携テスト
- **E2E Tests**: 重要なユーザーフロー

### テスト環境
```bash
# テストデータ環境
ADMIN_ENABLED=true
USE_TEST_DATA=true
TEST_DATA_PATH=./public/data_test
```

---

## 📈 パフォーマンス要件

### 応答時間
- **ダッシュボード**: 500ms以下
- **図番一覧**: 1秒以下
- **データ更新**: 3秒以下

### 同時接続
- **想定ユーザー**: 1-3名
- **同時編集**: 制限なし（楽観的ロック）

---

## 🚀 今後の展望

### Phase 4以降の構想
- **多言語対応**: 管理画面の国際化
- **AI機能**: 自動データ入力支援
- **外部連携**: ERPシステム連携
- **モバイル対応**: 管理画面のモバイル最適化

### 技術的改善
- **リアルタイム更新**: WebSocket導入
- **高度な権限管理**: RBAC実装
- **監査機能**: 詳細な操作ログ
- **パフォーマンス最適化**: キャッシュ戦略

---

## 📝 開発環境

### 必要な環境変数
```bash
# 管理画面制御
ADMIN_ENABLED=true
ADMIN_PASSWORD=your_secure_password

# データパス（既存）
USE_NAS=false
DEV_DATA_ROOT_PATH=./public/data

# デバッグ
DEBUG_ADMIN=true
```

### 開発コマンド
```bash
# 開発サーバー起動
npm run dev

# 管理画面テスト
npm run test:admin

# 管理画面ビルド
npm run build:admin
```

---

## 📋 開発チェックリスト

### Phase 1 チェックリスト
- [x] 管理画面基本レイアウト作成
- [ ] 認証機能実装
- [x] ダッシュボード統計表示
- [x] 図番一覧表示
- [x] 追記データ管理画面（編集ページ統合型）
- [ ] データ整合性チェック
- [x] 環境変数による制御
- [ ] 基本的なE2Eテスト

### Phase 2 チェックリスト
- [x] 図番新規登録フォーム（実装完了・動作確認済み）
- [x] 図番編集フォーム（実装完了・BOM除去対応済み）
- [x] ファイルアップロード機能（PDF対応）
- [x] 会社・製品管理（編集画面で表示のみ）
- [x] プレビュー機能（表示画面への遷移）
- [x] フォームバリデーション（必須項目・型チェック）
- [x] エラーハンドリング（詳細エラーメッセージ表示）
- [x] 機械種別タブ機能（マシニング・ターニング・横中・ラジアル・その他）
- [x] 機械種別フォルダ管理（step_01_machining形式）

### Phase 3 チェックリスト
- [ ] Excel インポート機能
- [ ] Excel エクスポート機能
- [ ] 一括処理機能
- [ ] バックアップ機能
- [ ] 監査ログ
- [ ] 権限管理
- [ ] 本格的なテスト

---

## 🎯 成功指標

### 効率性指標
- **データ更新時間**: 50%削減
- **作業ミス**: 80%削減
- **作業工数**: 60%削減

### 品質指標
- **データ整合性**: 100%維持
- **システム稼働率**: 99%以上
- **ユーザー満足度**: 4.5/5以上

---

## 📞 サポート体制

### 開発チーム
- **技術担当**: 開発チーム
- **要件定義**: システム管理者
- **テスト**: 運用チーム

### 運用開始後
- **Level 1**: 運用担当者
- **Level 2**: 開発チーム
- **Level 3**: プロジェクトマネージャー

---

## 🎉 実装進捗レポート（2025年8月9日更新）

### 📊 全体進捗
- **Phase 1**: 90% 完了（認証・データ整合性チェック残り）
- **Phase 2**: 100% 完了（機械種別タブ機能含む）
- **Phase 3**: 未着手
- **🎯 総合完成度**: 95%（運用レベル達成・機械種別対応完了）

### 🆕 最新の改善（2025年8月9日）

#### 機械種別機能の完全実装
- **✅ 機械種別タブUI実装**: マシニング・ターニング・横中・ラジアル・その他の5タブ
- **✅ フォルダ命名規約対応**: step_01_machining形式への移行（40図番、104ファイル完了）
- **✅ 横中タブ追加**: ターニングとラジアルの間に配置
- **✅ 削除機能改善**: actualFilesからの削除処理を修正
- **✅ 後方互換性維持**: 旧形式フォルダとの互換性確保

### 📝 前回の改善（2025年7月17日）

#### 図番一覧ページのUX大幅改善
- **検索ありき仕様**: 初期表示では全件表示せず、検索実行後に結果表示
- **検索条件緩和**: 「全ての会社」選択時も検索実行可能
- **全件検索対応**: 条件未指定時は確認ダイアログで全件表示可能
- **UI最適化**: 大きなアイコンを削除し、重複メッセージを統一
- **構文エラー修正**: 複雑な条件分岐を`renderContent()`関数で整理

#### 技術的改善
- **検索ロジック最適化**: 条件指定なしでの全件検索サポート
- **エラーハンドリング強化**: JSX構文エラーの完全解決
- **コード可読性向上**: 条件分岐の明確化とデバッグ性向上
- **✅ 型安全性大幅向上**: ESLintエラー完全解決、`any`型除去
- **✅ Next.js 15対応**: APIルート型定義をPromise対応に修正

### 📊 コード品質調査結果（2025年7月18日更新）

#### 🎯 総合評価: 90%完成度、品質良好、ビルド成功

**品質スコア:**
- **コード品質**: A- （型安全性大幅改善）
- **セキュリティ**: B- （認証周り強化必要）
- **保守性**: A- （良好な構造）
- **パフォーマンス**: B （最適化余地あり）

#### 🚨 現在の重要課題

**高優先度（要対応）**
1. **追記ステータス管理API未実装**
   - フロントエンドUI完成、バックエンドAPI未実装
   - 現在はローカル状態更新のみ（実際の更新なし）

2. **セキュリティ懸念**
   - ハードコードされた認証フォールバック `'admin123'`
   - 本番環境での意図しない露出リスク

**中優先度**
3. **パフォーマンス課題**: 図番一覧の全データ初期読み込み
4. **エラーハンドリング不統一**: alert vs UI表示の混在

#### ✅ 解決済み課題
1. **型安全性の問題**: ContributionData型定義修正により解決
2. **ビルドエラー**: 型定義と実装の整合性確保により解決

#### ✅ 良好な実装評価

1. **データ整合性**: トランザクション処理、BOM除去対応
2. **ユーザビリティ**: 検索ありき仕様、自動生成機能
3. **アーキテクチャ**: 適切なNext.js App Router活用

### ✅ 実装完了機能

#### 1. 管理画面ダッシュボード
- **URL**: `/admin`
- **機能**: 統計情報表示、最新追記一覧、各機能へのナビゲーション
- **状態**: ✅ 完成・動作確認済み
- **備考**: 追記管理カードをダッシュボードに復帰し、`/admin/contributions` へ遷移可能な導線を維持。

#### 2. 図番新規登録機能  
- **URL**: `/admin/drawings/new`
- **機能**: 複数件登録、自動生成、機械種別チェックボックス、PDF添付
- **状態**: ✅ 完成・動作確認済み
- **技術**: 3ファイル同期更新、トランザクション処理、フォルダ自動作成

#### 3. 図番一覧・編集機能
- **URL**: `/admin/drawings/list`, `/admin/drawings/[id]/edit`
- **機能**: 検索ありき一覧表示、検索・フィルタ、ページネーション、追記情報統合表示、編集フォーム
- **状態**: ✅ 完成・UX改善済み・動作確認済み
- **技術**: BOM除去対応、機械種別正規化、型安全性確保、検索条件緩和対応
- **🆕 UX改善**: 初期全件表示廃止、検索実行ありき仕様、UI最適化完了

#### 4. 追記管理機能（統合型）
- **場所**: 図番編集ページ内
- **機能**: 追記一覧表示、ステータス管理UI、詳細確認
- **状態**: ✅ UI完成（API未実装）
- **設計**: ステータス変更・削除機能準備済み

#### 5. 監査ログ一覧
- **URL**: `/admin/audit-log`
- **機能**: 直近200件の監査ログ表示、アクション種別フィルタ、期間（開始日・終了日）フィルタ、キーワード検索、メタデータ（changedFields など）の確認
- **データソース**: `public/data/audit/audit-YYYY-MM.jsonl`（最新月から読み込み）
- **備考**: 閲覧専用（編集・削除は提供しない）、ダッシュボードおよびヘッダーナビゲーションから遷移可能

### 🔧 技術的成果

#### データ構造対応
- **BOM除去**: JSONファイルの自動BOM除去機能
- **機械種別統一**: 長い名称→短い名称の正規化
- **型定義拡張**: `DrawingSearchItem`型の`difficulty`プロパティ追加

#### UI/UX改善
- **表示統一**: カンマ区切り機械種別の見やすい表示
- **エラーハンドリング**: 詳細なエラーメッセージとデバッグログ
- **レスポンシブ対応**: PC・タブレット対応完了
- **🆕 検索UX最適化**: 初期全件表示廃止、検索実行ありき仕様
- **🆕 UI簡素化**: 大きなアイコン削除、重複メッセージ統一
- **🆕 検索条件緩和**: 全会社選択時の検索実行可能化

#### セキュリティ・品質
- **入力検証**: 必須項目・型チェック・サニタイゼーション
- **トランザクション処理**: 更新失敗時の自動ロールバック
- **ファイル制限**: PDFファイルのサイズ・形式制限

### 🔧 改善計画・未実装機能

#### 短期改善（1週間以内 - 高優先度）
1. **追記ステータス管理API実装**
   - **URL**: `PATCH /api/admin/contributions/[drawingNumber]`
   - **内容**: pending→merged変更、削除処理API
   - **現状**: フロントエンドUI完成、API未実装
   - **影響**: 追記管理機能の完全動作

2. **セキュリティ強化**
   - **対象**: ハードコードされた認証フォールバック
   - **内容**: 安全なデフォルト値設定
   - **重要度**: 本番環境セキュリティ

#### 中期改善（1ヶ月以内 - 中優先度）
3. **認証機能強化**
   - **内容**: 基本パスワード認証、セッション管理
   - **現状**: 環境変数制御のみ
   - **URL**: `/admin/login`

4. **データ整合性チェック機能**  
   - **URL**: `/admin/tools/validate`
   - **内容**: 3ファイル間の整合性確認、不整合レポート
   - **現状**: 未着手

5. **パフォーマンス最適化**
   - **対象**: 図番一覧の段階的読み込み
   - **内容**: 検索結果キャッシュ化、遅延読み込み

### 🎯 今後の方針

#### 短期（1週間以内）
- **🚨 高優先**: 追記ステータス管理API実装
- **🔒 重要**: セキュリティ強化（認証フォールバック修正）

#### 中期（1ヶ月以内）  
- **🔐 機能**: 認証機能の基本実装
- **🔍 品質**: データ整合性チェック機能実装
- **⚡ 性能**: パフォーマンス最適化（段階的読み込み）

#### 長期（3ヶ月以内）
- **📊 機能**: Phase 3機能の実装検討
- **🏗️ 構造**: アーキテクチャ改善・重複コード除去
- **📈 拡張**: Excel処理・一括操作機能

---

**最終更新**: 2025年7月18日（buildエラー解決・型安全性確保）  
**次回レビュー**: 2025年8月18日  
**承認者**: プロジェクトマネージャー  
**管理者**: 開発チーム  

**📊 品質状況**: 総合完成度90%、実用レベル達成済み、ビルド成功  
**✅ 改善完了**: ContributionData型定義修正・ビルドエラー解決  
**🚨 要対応**: 追記ステータス管理API実装・セキュリティ強化  
