# 作業記録データベース プロジェクト概要仕様書

**作成日**: 2025年7月14日  
**バージョン**: 2.4.0  
**作成者**: Claude Code Analysis  
**ステータス**: 運用中・UI改善実施（2025/01/29）  

---

## 📋 プロジェクト概要

### システム名
**作業記録データベース** (Work Record Database)

### 目的
社内の製造・加工ノウハウを効率的に蓄積・検索・共有するためのWebアプリケーション

### コンセプト
- **階層構造による整理**: 会社 → 部品カテゴリ → 図番の3階層でノウハウを体系化
- **直感的な検索**: 図番による直接検索で迅速なアクセス
- **多様なメディア対応**: 画像・動画・図面を含む包括的な作業手順
- **多言語対応**: 日本語・英語・ベトナム語（準備中）

---

## 🏗️ システム構成

### アーキテクチャ
- **フロントエンド**: Next.js 15 + React 19 + TypeScript
- **スタイリング**: Tailwind CSS 4.1.8
- **データ管理**: 静的JSON + クライアントサイド検索
- **デプロイ**: サーバーレス対応

### 技術スタック詳細
```json
{
  "フレームワーク": "Next.js 15.3.3",
  "言語": "TypeScript 5",
  "UIライブラリ": "React 19.0.0",
  "スタイリング": "Tailwind CSS 4.1.8",
  "データ形式": "静的JSON",
  "ビルド": "Turbopack対応"
}
```

---

## 📁 データ構造

### 階層構造
```
会社 (Company)
├── 製品・部品カテゴリ (Product)
│   ├── 図番A (Drawing)
│   │   └── 作業手順 (Work Instruction)
│   ├── 図番B (Drawing)
│   └── 図番C (Drawing)
└── 製品・部品カテゴリ (Product)
```

### 主要データファイル
```
public/data/
├── companies.json          # 会社・製品・図番マスター
├── search-index.json       # 検索用インデックス
└── work-instructions/      # 作業手順データ
    └── drawing-{図番}/
        ├── instruction.json # 作業手順詳細（ベースデータ）
        ├── contributions/  # 🆕 追記データ（分離管理）
        │   ├── contributions.json # 追記一覧
        │   └── files/            # 追記ファイル
        │       ├── images/       # 追記画像（複数ファイル対応）
        │       └── videos/       # 追記動画（複数ファイル対応）
        ├── images/         # ベース画像ファイル
        ├── videos/         # ベース動画ファイル
        ├── pdfs/          # 図面・資料
        └── programs/      # プログラムファイル
```

### データスキーマ

#### Company（会社）
```typescript
interface Company {
  id: string;
  name: string;
  shortName: string;
  description: string;
  priority: number;
  products: Product[];
}
```

#### Product（製品・部品）
```typescript
interface Product {
  id: string;
  name: string;
  category: string;
  description: string;
  drawingCount: number;
  drawings: string[];
}
```

#### WorkInstruction（作業手順）
```typescript
interface WorkInstruction {
  metadata: InstructionMetadata;
  overview: InstructionOverview;
  workSteps: WorkStep[];
  relatedDrawings: RelatedDrawing[];
  troubleshooting: TroubleshootingItem[];
  revisionHistory: RevisionHistory[];
  relatedIdeas?: string[]; // 加工アイデア関連付け
}
```

---

## 🎯 主要機能

### 1. 階層ナビゲーション
- **会社選択**: 各会社の製品一覧を表示
- **部品選択**: 選択した部品の図番一覧を表示
- **図番選択**: 詳細な作業手順を表示

### 2. 図番検索機能
- **直接検索**: 図番を入力して即座に作業手順にアクセス
- **検索候補**: 入力に応じたリアルタイム候補表示
- **検索履歴**: よく使用される図番の履歴保存

### 3. 作業手順表示
- **工程別表示**: 各工程の詳細手順（トグル表示対応）
- **メディア表示**: 画像・動画・図面の統合表示
- **品質チェック**: 各工程での検査項目
- **関連図番**: 控えめなボタンで表示（2025/01/29改善）

### 4. トラブルシューティング
- **問題・原因・解決策**: 体系化された対策情報
- **事例検索**: 過去のトラブル事例からの学習

### 5. コミュニティ追記機能 🆕
- **追記投稿**: 作業手順への現場知見の追加
- **✅ 複数ファイル対応**: 1回の投稿で複数の画像・動画を同時アップロード
- **マルチメディア**: テキスト・画像・動画の投稿対応
- **ファイルプレビュー**: 投稿前の選択ファイル確認機能
- **統合表示**: 既存手順と追記の一体化表示
- **履歴管理**: トップページでの最新追記一覧
- **見逃し防止**: 全社での知見共有促進

---

## 🌍 ユーザー体験

### 基本フロー
1. **会社選択** → 製造対象会社を選択
2. **部品選択** → 作業対象の部品カテゴリを選択  
3. **図番選択** → 具体的な図番を選択
4. **作業実行** → 詳細手順に従って作業実行

### 高速アクセスフロー
1. **図番検索** → 図番を直接入力
2. **作業実行** → 即座に作業手順を表示

### UI/UX特徴
- **レスポンシブデザイン**: PC・タブレット・スマートフォン対応
- **直感的操作**: カード型UI による分かりやすい選択
- **高速レスポンス**: クライアントサイド処理による瞬時表示
- **視覚的情報**: 豊富な画像・動画による理解促進

---

## 📊 運用データ

### 現在の収録データ（想定）
- **対象会社**: 5社程度
- **製品カテゴリ**: 各社2-3カテゴリ
- **収録図番**: 総数65件程度
- **メディアファイル**: 画像・動画・図面を含む

### データ管理方式
- **Excelテンプレート**: データ入力の標準化
- **JSON変換**: システム用データへの自動変換
- **ファイル命名規則**: 一貫性のあるメディア管理
- **バージョン管理**: Git による変更履歴管理

---

## 🔧 開発・運用環境

### 開発環境セットアップ
```bash
# 依存関係インストール
npm install

# 開発サーバー起動
npm run dev

# 本番ビルド
npm run build
```

### 環境変数設定

#### ローカル開発環境（NAS不使用）
```bash
# 基本設定
NODE_ENV=development
DEBUG_DATA_LOADING=true

# データパス設定（ローカル開発用）
USE_NAS=false
NEXT_PUBLIC_USE_NAS=false
DEV_DATA_ROOT_PATH=./public/data_test

# NAS設定（未使用時でも定義）
DATA_ROOT_PATH=C:\work\projects\work-record-database\public\data
```

#### NAS開発環境（NAS使用）
```bash
# 基本設定
NODE_ENV=development
DEBUG_DATA_LOADING=true

# データパス設定（NAS使用）
USE_NAS=true
NEXT_PUBLIC_USE_NAS=true
DATA_ROOT_PATH=C:\work\projects\work-record-database\public\data

# ローカル設定（未使用時でも定義）
DEV_DATA_ROOT_PATH=./public/data_test
```

#### 本番環境
```bash
# 基本設定
NODE_ENV=production

# データパス設定（本番NAS使用）
USE_NAS=true
NEXT_PUBLIC_USE_NAS=true
DATA_ROOT_PATH=/mnt/nas/project-data
```

#### 環境変数の説明
- **`USE_NAS`**: サーバーサイドのデータソース切り替え（true: NAS使用, false: ローカル使用）
- **`NEXT_PUBLIC_USE_NAS`**: クライアントサイドのデータソース切り替え（重要：サーバーサイドと同じ値に設定）
- **`DATA_ROOT_PATH`**: NAS使用時のデータルートパス
- **`DEV_DATA_ROOT_PATH`**: ローカル開発時のデータルートパス
- **`DEBUG_DATA_LOADING`**: データ読み込みの詳細ログ出力（開発時のみ）

### ディレクトリ構造
```
src/
├── app/                    # Next.js App Router
│   ├── page.tsx           # メインページ（会社選択）
│   ├── category/          # 部品選択ページ
│   ├── drawings/          # 図番選択ページ
│   ├── instruction/       # 作業手順詳細ページ
│   └── api/               # APIエンドポイント
├── components/            # Reactコンポーネント
├── lib/                  # ユーティリティ・データローダー
└── types/                # TypeScript型定義
```

---

## 🚀 拡張機能

### Phase B: 機能追加

#### 1. 作業手順の入力・アップロード機能
- **✅ 追記システム**: 既存作業手順への追記投稿機能（2025/07/14実装完了）
- **✅ マルチメディア対応**: テキスト・画像・動画の投稿（2025/07/14実装完了）
- **✅ 複数ファイル対応**: 1回の投稿で複数ファイル同時アップロード（2025/07/15完了）
- **✅ 分離型データ管理**: 本体データと追記データの完全分離
- **✅ 統合表示**: ベースデータと追記の一体表示
- **✅ 履歴管理**: トップページでの全追記一元表示
- **✅ ユーザーフレンドリー**: 投稿意欲を高める UX 設計
- **✅ ファイル配信統一**: 開発・本番環境での一貫した動作保証

**技術詳細:**
- 追記データ: `/work-instructions/drawing-XXX/contributions/`
- API: `/api/contribution` (POST/GET), `/api/files` (統一ファイル配信)
- 型安全: 完全なTypeScript対応
- セキュリティ: ファイルパスサニタイゼーション・ファイル検証実装
- **✅ 複数ファイル処理**: FormData配列処理・並列アップロード対応
- **✅ 統一ファイル配信**: `/api/files`による作業手順・追記ファイルの一元配信

#### 2. 不具合履歴機能
- **不具合記録**: Case別の詳細な問題管理
- **画像・動画添付**: 証拠資料の保存
- **対策履歴**: 解決方法の蓄積
- **確認ボタン**: 概要画面での履歴確認

#### 3. 検査成績書機能
- **フォーム入力**: Web上での検査データ入力
- **PDF生成**: 自動的な報告書作成
- **ファイル保存**: 日付・担当者名での管理
- **履歴表示**: 過去の検査記録一覧

### Phase C: 本格リファクタリング（1-2日）
- **コンポーネント分割**: 保守性向上
- **CSS整理**: スタイルの最適化
- **パフォーマンス最適化**: 読み込み速度向上

---

## 🔒 セキュリティ・品質管理

### セキュリティ方針
- **社内ネットワーク限定**: 社外からのアクセス不可
- **データアクセス**: 閲覧ページで全図番データ参照可能
- **認証要件**: 管理画面アクセス時のみパスワード認証（編集フォーマット統一と同時編集防止が目的）
- **ファイル表示**: 閲覧・管理画面ともに直接パス参照で統一

### 実装済みセキュリティ対策
- **ファイルパスサニタイゼーション**: 不正アクセス防止
- **入力値検証**: APIパラメータの厳格チェック
- **環境別ログ制御**: 本番環境での情報漏洩防止

### 品質管理要件
- **不具合履歴の可視性**: 問題の早期発見
- **追跡可能性**: 全作業工程の記録
- **継続改善**: 対策知識の蓄積

---

## 📈 技術的改善点

### 完了した最適化
- ✅ **設定ファイル重複解消**: 構成の明確化（2025/07/14）
- ✅ **不要パッケージ削除**: バンドルサイズ削減（84パッケージ削除）
- ✅ **AI機能削除**: 不要機能の除去
- ✅ **型定義統一**: 開発効率向上
- ✅ **エラーハンドリング統一**: 保守性向上
- ✅ **デバッグログ最適化**: 本番パフォーマンス向上
- ✅ **ファイル配信API統一**: `/api/files`による一元的なファイル配信（2025/07/15）
- ✅ **コードベース整理**: 重複コード削除・不要ファイル削除（約70行削減）
- ✅ **UI/UX改善**: 作業詳細ページの大幅改善（2025/01/29）
  - アイコン変更（PDF→🔴、プログラム→📄）
  - 編集画面の画像グリッド表示
  - 工程のトグル表示機能
  - 関連情報の配置最適化
  - 編集画面で追記情報を独立タブに分離
  - 追記画像のライトボックス表示対応
- ✅ **管理画面編集機能改善**: 作業手順と追記情報の統合表示（2025/01/30）
  - 左右分割レイアウトで同時編集可能
  - 独立スクロール領域で効率的な作業
  - レスポンシブ対応（準備中）
  - ドラッグ&ドロップで追記画像を作業手順に転記
  - クリックでのファイルアップロードも対応
- ✅ **追記情報ライフサイクル管理**: activeとmergedステータスの運用（2025/01/30）
  - 全追記一覧ページ（閲覧用）の実装
  - 追記管理ページ（管理用）の実装
  - ステータス変更API（active ⇔ merged、削除）
  - 編集画面でのマージ済み追記の非表示化

### パフォーマンス特性
- **初回読み込み**: ~105KB（高速）
- **検索応答**: 瞬時（クライアントサイド）
- **画像表示**: 遅延読み込み対応
- **キャッシュ効果**: ブラウザ最適化

---

## 📞 運用・保守

### データ更新手順
1. **Excelテンプレート**: 標準フォーマットでデータ入力
2. **JSON変換**: 自動変換スクリプト実行
3. **ファイル配置**: 規定ディレクトリに保存
4. **整合性チェック**: データ一貫性確認
5. **デプロイ**: 本番環境への反映

### 監視・メンテナンス
- **ログ監視**: エラー発生の早期検知
- **パフォーマンス監視**: 応答時間の定期確認
- **データ整合性**: 定期的な一貫性チェック
- **バックアップ**: 定期的なデータ保護

### サポート体制
- **技術サポート**: 開発チーム
- **運用サポート**: システム管理者
- **緊急時対応**: プロジェクトマネージャー

---

## 🎯 今後のビジョン

### 短期目標（3ヶ月）
- 新機能3種の実装完了
- ユーザビリティの向上
- データ入力の効率化

### 中期目標（6ヶ月）
- 多言語対応の完全実装
- AI活用機能の再検討
- モバイル最適化

### 長期目標（1年）
- 他部門への展開
- 外部システム連携
- 高度な分析機能

---

## 📚 関連ドキュメント

### 技術仕様書
- [データスキーマ仕様書](./データスキーマ仕様書.md)
- [データアップデート運用手順書](./データアップデート運用手順書.md)
- [不具合履歴・加工アイデア機能追加仕様書](./不具合履歴・加工アイデア機能追加仕様書.md)
- [検査報告書機能追加構想](./検査報告書機能追加構想.md)

### 改善・メンテナンス
- [コードベース改善課題一覧](./コードベース改善課題一覧.md)

### 過去の仕様書
- [要件定義書](./要件定義書.md)
- [詳細仕様書](./詳細仕様書.md)

---

## 🏆 成果・効果

### 業務効率化
- **検索時間短縮**: 図番検索による即座アクセス
- **情報一元化**: 散在していたノウハウの統合
- **品質向上**: 標準化された作業手順

### 技術的成果
- **モダンな技術スタック**: 将来の拡張性確保
- **高いパフォーマンス**: ユーザー体験の向上
- **保守性**: クリーンなコードベース

### 組織的効果
- **ノウハウ蓄積**: 属人化の解消
- **教育効率**: 新人教育の標準化
- **品質管理**: トレーサビリティの向上
- **🆕 知見共有**: コミュニティ追記による現場知見の活用
- **🆕 継続改善**: リアルタイムな現場フィードバック収集

---

**最終更新**: 2025年1月30日（管理画面編集機能改善）  
**次回レビュー**: 2025年2月29日  
**承認者**: プロジェクトマネージャー  
**管理者**: 開発チーム  